@model AbarroteriaKary.ModelsPartial.ProveedorFormViewModel

@{
    ViewData["Title"] = "Editar Proveedor";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var updatedOk = TempData["UpdatedOk"] as bool?;
    var updatedName = TempData["UpdatedName"] as string ?? "";
    var noChanges = TempData["NoChanges"] as bool?;
}

<div class="ak-page">
    <!-- Título -->
    <div class="ak-header container-fluid px-3 px-md-4">
        <h1 class="ak-form-title m-1 mb-4">Editar proveedor</h1>
    </div>

    <!-- Formulario -->
    <div class="ak-main">
        <div class="container-fluid px-3 px-md-4">

            <form asp-action="Edit" asp-route-id="@Model.Id" method="post" id="form-edit-proveedor" novalidate>
                @Html.AntiForgeryToken()

                <div class="alert alert-danger mb-3" asp-validation-summary="All" role="alert"></div>

                <!-- Card principal -->
                <div class="card ak-card translucent shadow-sm w-100 mb-3">
                    <div class="card-body ak-form">
                        <!-- Código (readonly) + Estado -->
                        <div class="row g-3">
                            <div class="col-12 col-md-3">
                                <label asp-for="Id" class="form-label">Código</label>
                                <input asp-for="Id" class="form-control" readonly />
                            </div>
                            <div class="col-12 col-md-9 d-flex align-items-end">
                                <div class="form-check d-flex align-items-center gap-2 mb-0">
                                    <input class="form-check-input ak-checkbox" asp-for="EstadoActivo" />
                                    <label class="form-check-label fw-bold" asp-for="EstadoActivo"></label>
                                    <input type="hidden" asp-for="ESTADO" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                      


                        <!-- Bloque 2: Datos de empresa (PROVEEDOR.PROVEEDOR_EMPRESA / PROVEEDOR_OBSERVACION) -->
                        <div class="card ak-card translucent shadow-sm w-100 mb-3">
                          <div class="card-body ak-form">
                                <h5 class="mb-3">Datos de empresa</h5>
                                <div class="row g-3">
                                    <!-- PROVEEDOR.PROVEEDOR_EMPRESA -->
                                    <div class="col-6 col-md-6">
                                        <label asp-for="Empresa" class="form-label">Nombre de la empresa</label>
                                        <input asp-for="Empresa" class="form-control" placeholder="Ej. Distribuidora La Esperanza, S.A." />
                                        <span asp-validation-for="Empresa" class="text-danger"></span>

                                    </div>
                                    <div class="col-6 col-md-6">
                                        <label asp-for="TelefonoCasa" class="form-label">Teléfono Empresa</label>
                                        <input asp-for="TelefonoCasa" class="form-control" />
                                        <span asp-validation-for="TelefonoCasa" class="text-danger"></span>

                                    </div>
                                    <!-- PROVEEDOR.PROVEEDOR_OBSERVACION -->
                                    <div class="col-12 col-md-12">
                                        <label asp-for="ProveedorObservacion" class="form-label">Observación</label>
                                        <input asp-for="ProveedorObservacion" class="form-control" placeholder="Ej. Entregas priorizadas lunes/miércoles" />
                                        <span asp-validation-for="ProveedorObservacion" class="text-danger"></span>
                                    </div>
                              </div>
                            </div>
                       </div>



                    <div class="card ak-card translucent shadow-sm w-100 mb-3">
                        <div class="card-body ak-form">
                        <!-- Bloque 1: Datos personales del proveedor (PERSONA.*) -->
                            <h5 class="mb-3">Datos personales del proveedor</h5>
                            <div class="row g-3">
                                <!-- PERSONA.PERSONA_PRIMERNOMBRE -->
                                <div class="col-12 col-md-4">
                                    <label asp-for="PrimerNombre" class="form-label">Primer nombre*</label>
                                    <input asp-for="PrimerNombre" class="form-control" />
                                    <span asp-validation-for="PrimerNombre" class="text-danger"></span>
                                </div>

                                <!-- PERSONA.PERSONA_SEGUNDONOMBRE -->
                                <div class="col-12 col-md-4">
                                    <label asp-for="SegundoNombre" class="form-label">Segundo nombre</label>
                                    <input asp-for="SegundoNombre" class="form-control" />
                                </div>

                                <!-- PERSONA.PERSONA_TERCERNOMBRE -->
                                <div class="col-12 col-md-4">
                                    <label asp-for="TercerNombre" class="form-label">Tercer nombre</label>
                                    <input asp-for="TercerNombre" class="form-control" />
                                </div>

                                <!-- PERSONA.PERSONA_PRIMERAPELLIDO -->
                                <div class="col-12 col-md-4">
                                    <label asp-for="PrimerApellido" class="form-label">Primer apellido*</label>
                                    <input asp-for="PrimerApellido" class="form-control" />
                                    <span asp-validation-for="PrimerApellido" class="text-danger"></span>
                                </div>

                                <!-- PERSONA.PERSONA_SEGUNDOAPELLIDO -->
                                <div class="col-12 col-md-4">
                                    <label asp-for="SegundoApellido" class="form-label">Segundo apellido</label>
                                    <input asp-for="SegundoApellido" class="form-control" />
                                </div>

                            <!-- PERSONA.PERSONA_TELEFONOMOVIL -->
                            <div class="col-12 col-md-4">
                                <label asp-for="TelefonoMovil" class="form-label">Teléfono móvil*</label>
                                <input asp-for="TelefonoMovil" class="form-control" />
                                <span asp-validation-for="TelefonoMovil" class="text-danger"></span>
                            </div>

                                <!-- PERSONA.PERSONA_DIRECCION -->
                                <div class="col-12 col-md-6">
                                    <label asp-for="Direccion" class="form-label">Dirección*</label>
                                    <input asp-for="Direccion" class="form-control" />
                                    <span asp-validation-for="Direccion" class="text-danger"></span>
                                </div>


                                <!-- PERSONA.PERSONA_CORREO -->
                                <div class="col-12 col-md-6">
                                    <label asp-for="Correo" class="form-label">Correo</label>
                                    <input asp-for="Correo" class="form-control" />
                                    <span asp-validation-for="Correo" class="text-danger"></span>
                                </div>
                            </div>                                     
                        </div>
                    </div>
                


                <!-- Acciones -->
                <div class="card ak-card ak-actions-card w-100 mt-3">
                    <div class="card-body d-flex justify-content-center gap-5 flex-wrap">
                        <a asp-action="Index" class="btn btn-ak btn-ak-cancel js-leave">
                            <i class="fa-solid fa-xmark ak-icon"></i> Cancelar
                        </a>
                        <button type="reset" class="btn btn-ak btn-ak-success">
                            <i class="fa-solid fa-eraser ak-icon"></i> Restablecer
                        </button>
                        <button type="submit" class="btn btn-ak btn-ak-primary" id="btn-guardar">
                            <i class="fa-solid fa-floppy-disk ak-icon"></i> Guardar
                        </button>
                    </div>
                </div>
            </form>

        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function () {
            const form = document.getElementById('form-edit-proveedor');
            const btn  = document.getElementById('btn-guardar');


                KaryForms.bindSafeSubmit('#form-edit-proveedor', '#btn-guardar', {
          spinnerHtml: '<i class="fa-solid fa-spinner fa-spin ak-icon"></i> Guardando...'
        });




            // Evitar doble submit
            if (form) {
                form.addEventListener('submit', function () {
                    if (!form.checkValidity()) return;
                    if (btn) btn.disabled = true;
                });

                // Proteger salida con cambios sin guardar
                if (window.KarySwal && KarySwal.guardUnsaved) {
                    KarySwal.guardUnsaved('#form-edit-proveedor', '.js-leave');
                }
            }

            // Éxito: ACTUALIZADO -> un botón "Aceptar" y regresar al listado
            @if ((TempData["UpdatedOk"] as bool?) == true)
            {
                    <text>
                    if (window.KarySwal && KarySwal.saveSuccess) {
                        KarySwal.saveSuccess({
                            icon: 'success',
                            title: '¡Actualizado exitosamente!',
                            text: 'Los cambios de "@(TempData["UpdatedName"] as string ?? "")" se guardaron correctamente.',
                            confirmText: 'Aceptar',
                            showDenyButton: false,
                            indexUrl: '@Url.Action("Index", "Proveedores")'
                        });
                    }
                    </text>
            }

            // Info: NO SE MODIFICÓ NADA -> botón "Aceptar" que redirige al listado
            @if ((TempData["NoChanges"] as bool?) == true)
            {
                    <text>
                    if (window.KarySwal && KarySwal.info) {
                        KarySwal.info({
                            title: 'Sin cambios',
                            text: 'No se realizó ninguna modificación.',
                            confirmText: 'Aceptar',
                            redirectUrl: '@Url.Action("Index", "Proveedores")'
                        });
                    } else {
                        // Fallback sin helper
                        alert('No se realizó ninguna modificación.');
                        window.location.href = '@Url.Action("Index", "Proveedores")';
                    }
                    </text>
            }
        })();
    </script>
}

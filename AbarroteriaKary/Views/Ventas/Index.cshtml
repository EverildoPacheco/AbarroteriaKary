@* ============================================
   VENTAS / INDEX
   - Estilo idéntico a tus Index (Áreas/Puestos/Empleados)
   - Barra superior con: Nueva venta, menú "Caja", filtros de estado, búsqueda y rango de fechas (VENTA.FECHA)
   - Tabla: Código venta, Fecha, Cliente, Vendedor, Total, Estado, Acciones
   - Paginación con _Pager
   - Incluye wiring para Caja (apertura/cierre) y habilitar "Nueva venta"
   ============================================ *@

@model AbarroteriaKary.ModelsPartial.Paginacion.PaginadoViewModel<AbarroteriaKary.ModelsPartial.VentaViewModel>
@using System.Globalization

@{
    ViewData["Title"] = "Ventas";
    Layout = "~/Views/Shared/_Layout.cshtml";

    string estado = (ViewBag.Estado as string) ?? "ACTIVO";
    string q = ViewBag.Q as string;
    string fDesde = ViewBag.FDesde as string;
    string fHasta = ViewBag.FHasta as string;

    // Caja actual: el controlador debe setear ViewBag.CajaId
    string cajaIdActual = ViewBag.CajaId as string ?? "";

    string rangoTexto = "";
    if (DateTime.TryParse(fDesde, out var d1) && DateTime.TryParse(fHasta, out var d2))
        rangoTexto = $"{d1:dd/MM/yyyy} - {d2:dd/MM/yyyy}";
}

<!-- Hidden con la caja actual (utilizado por caja-sesion.js para consultar estado y abrir/ cerrar) -->
<input type="hidden" id="CajaIdActual" value="@cajaIdActual" />

<!-- CARD / TOOLBAR -->
<div class="ak-toolbar mb-4 mt-4">
    <div class="ak-toolbar__row">
        <h1 class="ak-toolbar__title m-0">Ventas</h1>

        <div class="ak-toolbar__right">

            <!-- NUEVA VENTA: deshabilitado si no hay sesión abierta (se habilita por JS al cargar) -->
            <a asp-action="Create" asp-controller="Ventas"
               id="btnNuevaVenta"
               class="btn btn-ak-primary btn-ak-square d-inline-flex align-items-center gap-2 disabled"
               aria-disabled="true" title="Inicie una nueva venta">
                <i class="fa-solid fa-cart-shopping"></i><span>Nueva venta</span>
            </a>

            <!-- Menú CAJA: Aperturar / Cerrar -->
            <div class="dropdown d-inline-block">
                <button class="btn btn-ak-primary btn-ak-square dropdown-toggle d-inline-flex align-items-center gap-2"
                        type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fa-solid fa-cash-register"></i><span>Caja</span>
                </button>
                <ul class="dropdown-menu">
                    <li>
                        <a class="dropdown-item d-flex align-items-center gap-2" href="#" id="btnAperturarCaja">
                            <i class="fa-regular fa-square-plus"></i> Aperturar caja
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item d-flex align-items-center gap-2" href="#" id="btnCerrarCaja">
                            <i class="fa-regular fa-square-minus"></i> Cerrar caja
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Filtros de estado (preserva pageSize y reinicia a página 1) -->
            <a asp-action="Index" asp-route-estado="TODOS" asp-route-q="@q"
               asp-route-fDesde="@fDesde" asp-route-fHasta="@fHasta"
               asp-route-page="1" asp-route-pageSize="@Model.PageSize"
               class="btn btn-ak-filter btn-ak-square @(estado == "TODOS" ? "active" : "")">
                <i class="fa-solid fa-layer-group me-1"></i>Todos
            </a>

            <a asp-action="Index" asp-route-estado="ACTIVO" asp-route-q="@q"
               asp-route-fDesde="@fDesde" asp-route-fHasta="@fHasta"
               asp-route-page="1" asp-route-pageSize="@Model.PageSize"
               class="btn btn-ak-filter btn-ak-square @(estado == "ACTIVO" ? "active" : "")">
                <i class="fa-solid fa-check me-1"></i>Activo
            </a>

            <a asp-action="Index" asp-route-estado="INACTIVO" asp-route-q="@q"
               asp-route-fDesde="@fDesde" asp-route-fHasta="@fHasta"
               asp-route-page="1" asp-route-pageSize="@Model.PageSize"
               class="btn btn-ak-filter btn-ak-square @(estado == "INACTIVO" ? "active" : "")">
                <i class="fa-solid fa-ban me-1"></i>Inactivo
            </a>

            @* Dropdown de Reporte (si ya usas este parcial global) *@
            @{
                var repVm = new AbarroteriaKary.ModelsPartial.ReporteDropdownVM
                {
                    Controller = "Ventas",
                    ExportAction = "Exportar",
                    Label = "Reporte",
                    SizeCss = "btn btn-ak-primary btn-ak-square",
                    Estado = ViewBag.Estado as string,
                    Q = ViewBag.Q as string,
                    FDesde = ViewBag.FDesde as string,
                    FHasta = ViewBag.FHasta as string
                };
            }
            @await Html.PartialAsync("~/Views/Shared/Reportes/_ReporteDropdown.cshtml", repVm)

            <!-- Buscador + Rango de fechas -->
            <form id="frmFiltros" method="get" asp-action="Index"
                  class="d-inline-flex align-items-center gap-2">
                <input type="hidden" name="estado" value="@estado" />
                <input type="hidden" name="page" value="1" />                 @* Reinicia página *@
                <input type="hidden" name="pageSize" value="@Model.PageSize" />@* Preserva pageSize *@

                <!-- RANGO FECHAS (VENTA.FECHA) -->
                <div class="input-group ak-daterange-group" style="width:clamp(220px, 20vw, 260px);">
                    <span class="input-group-text bg-white border-end-0" title="Rango de fechas">
                        <i class="fa-regular fa-calendar"></i>
                    </span>

                    <input id="rangoFechas"
                           class="form-control border-start-0 border-end-0"
                           placeholder="Buscar por fecha"
                           value="@rangoTexto"
                           autocomplete="off" />

                    <button type="button" id="btnClearRange"
                            class="input-group-text bg-white border-start-0"
                            title="Limpiar rango">
                        <i class="fa-solid fa-eraser"></i>
                    </button>
                </div>

                <input type="hidden" name="fDesde" id="fDesde" value="@fDesde" />
                <input type="hidden" name="fHasta" id="fHasta" value="@fHasta" />

                <!-- BUSCADOR -->
                <div class="input-group ak-search" style="width:clamp(260px, 24vw, 320px);">
                    <button type="submit" class="input-group-text bg-white border-end-0" title="Buscar">
                        <i class="fas fa-search"></i>
                    </button>
                    <input name="q" value="@q" class="form-control border-start-0"
                           placeholder="Código, Cliente o Vendedor" />
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Tabla -->
<div class="table-responsive">
    <table class="table table-bordered table-striped table-hover align-middle table-kary-zebra js-sortable">
        <thead class="text-center thead-kary">
            <tr>
                @if (Model.Items.Any())
                {
                    <th data-type="text">@Html.DisplayNameFor(m => m.Items[0].VentaId)</th>
                    <th data-type="date:dd/MM/yyyy">@Html.DisplayNameFor(m => m.Items[0].FechaVenta)</th>
                    <th data-type="text">@Html.DisplayNameFor(m => m.Items[0].ClienteId)</th>
                    <th data-type="text">@Html.DisplayNameFor(m => m.Items[0].UsuarioId)</th>
                    <th data-type="number">@Html.DisplayNameFor(m => m.Items[0].Total)</th>
                    // <th data-type="text">Estado</th>
                }
                else
                {
                    <th>Código venta</th>
                    <th>Fecha</th>
                    <th>Cliente</th>
                    <th>Vendedor</th>
                    <th>Total</th>
                    // <th>Estado</th>
                }
                <th>Acciones</th>
            </tr>
        </thead>

        <tbody>
            @if (!Model.Items.Any())
            {
                <tr>
                    <td colspan="7" class="text-center py-4 text-muted">
                        <i class="fa-regular fa-face-frown me-1"></i> No hay resultados.
                    </td>
                </tr>
            }
            else
            {
                foreach (var v in Model.Items)
                {
                    // bool esActivo = string.Equals(e.ESTADO, "ACTIVO", StringComparison.OrdinalIgnoreCase);

                    <tr>
                        <td class="text-monospace">@v.VentaId</td>
                        <td>@v.FechaVenta.ToString("dd/MM/yyyy", CultureInfo.GetCultureInfo("es-GT"))</td>
                        <td>@(string.IsNullOrWhiteSpace(v.ClienteId) ? "-" : v.ClienteId)</td>
                        <td>@(string.IsNullOrWhiteSpace(v.UsuarioId) ? "-" : v.UsuarioId)</td>
                        <td class="text-end">@v.Total.ToString("C2", CultureInfo.GetCultureInfo("es-GT"))</td>
                       

                        <td class="text-center acciones">
                            <a href="@Url.Action("Details", "Ventas", new { id = v.VentaId })" class="btn btn-sm me-2" title="Ver detalle">
                                <img src="~/img/Botones/vision1.png" alt="Ver" class="icono-accion">
                            </a>


                            <a asp-controller="Ventas"
                               asp-action="Recibo"
                               asp-route-id="@v.VentaId"
                               target="_blank" rel="noopener"
                               class="btn btn-sm" title="Ver PDF">
                                <img src="~/img/Botones/pdf.png" alt="PDF" class="icono-accion">
                            </a>




                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>

    @* Paginador (mismo parcial global) *@
    @await Html.PartialAsync("_Pager", Model)
</div>

@* Host para inyectar los       // <div id="ak-modal-host"></div>
                modales de CAJA (apertura/cierre) *@


<!-- Host para inyectar modales -->
<div id="ak-modal-host"></div>

<!-- Caja actual (DEBE tener valor) -->
<input type="hidden" id="CajaIdActual" value="@ViewBag.CajaId" />


@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        (function () {
          'use strict';

          const form   = document.getElementById('frmFiltros');
          if (!form) return;

          const input  = document.getElementById('rangoFechas');
          const fDesde = document.getElementById('fDesde');
          const fHasta = document.getElementById('fHasta');
          const btnClr = document.getElementById('btnClearRange');
          const estadoH = form.querySelector('input[name="estado"]');

          if (input && input._litepicker && typeof input._litepicker.destroy === 'function') {
            input._litepicker.destroy();
          }

          const start = '@(ViewBag.FDesde as string ?? "")';
          const end   = '@(ViewBag.FHasta as string ?? "")';

          const picker = new Litepicker({
            element: input,
            singleMode: false,
            autoApply: true,
            allowRepick: true,
            numberOfMonths: 2,
            numberOfColumns: 2,
            splitView: true,
            format: 'DD/MM/YYYY',
            lang: 'es-ES',
            startDate: start || null,
            endDate: end || null
          });

          picker.on('selected', (s, e) => {
            if (s && e) {
              fDesde.value = s.format('YYYY-MM-DD');
              fHasta.value = e.format('YYYY-MM-DD');
              form.submit();
            }
          });

          if (btnClr) {
            btnClr.addEventListener('click', () => {
              input.value = '';
              fDesde.value = '';
              fHasta.value = '';
              try { picker.clearSelection(); } catch {}
              if (estadoH) estadoH.value = 'ACTIVO';
              form.submit();
            });
          }

          picker.on('render', () => {
            document.querySelectorAll(
              '.litepicker .month-item-header .month-name, .litepicker .month-item-header .year-number'
            ).forEach(el => el.style.cursor = 'pointer');
          });
        })();
    </script>

    <!-- Wiring Caja centralizado (apertura/cierre/estado) -->
    <script src="~/js/caja-sesion.js"></script>
}


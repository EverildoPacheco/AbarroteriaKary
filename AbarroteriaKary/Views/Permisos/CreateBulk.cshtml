@model AbarroteriaKary.ModelsPartial.PermisoBulkVM
@{
    ViewData["Title"] = "Asignar permisos por Rol";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid permiso-create page-create">
    <h4 class="mb-3">Crear permisos por rol</h4>

    <!-- ===== Filtros (Rol / Módulo) ===== -->
    <section class="filters-section">
        <div class="filter-group">
            <label for="ddlRol">Rol <span class="text-danger">*</span></label>
            <select asp-for="RolId" asp-items="Model.Roles" id="ddlRol" class="form-select">
                <option value="">Seleccione…</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="ddlModulo">Módulo <span class="text-danger">*</span></label>
            <select asp-for="ModuloId" asp-items="Model.Modulos" id="ddlModulo" class="form-select" disabled>
                <option value="">Seleccione…</option>
            </select>
        </div>
    </section>

    <!-- ===== Grid 2 columnas: módulos / submódulos ===== -->
    <main class="permissions-grid">
        <!-- Izquierda: módulos -->
        <aside class="panel modules-panel">
            <h3>Módulos</h3>
            <ul id="modList" class="modules-list">
                @foreach (var m in Model.Modulos)
                {
                    <li class="module-item mod-item d-flex justify-content-between align-items-center"
                        data-id="@m.Value" tabindex="0" role="button" aria-pressed="false">
                        <span>@m.Text</span>
                        <i class="bi bi-chevron-right opacity-50"></i>
                    </li>
                }
            </ul>
        </aside>

        <!-- Derecha: submódulos + acciones -->
        <section class="panel submodules-panel">
            <div class="submods-header">
                <h3>Submódulos y Permisos</h3>
                <div class="text-center">
                    <small id="lblContexto" class="context-hint">Seleccione un módulo…</small>
                </div>
            </div>

            <!-- FORM: MultiBulk Create -->
            <form asp-action="SaveMultiAssign" method="post" id="frmBulk">
                @Html.AntiForgeryToken()

                <div asp-validation-summary="All" class="alert alert-danger mb-3 d-none" id="valSummary" role="alert"></div>

                <!-- Contexto para el POST -->
                <input type="hidden" name="RolId" id="hidRol" />
                <!-- Importante: SIN name (el JS construye Modules[i] dinámicamente) -->
                <input type="hidden" id="hidModulo" />

                <!-- Aquí el JS inyecta TODOS los Modules[i].Items[j] -->
                <div id="multiPayload" hidden></div>

                <!-- Loader / error -->
                <div id="loadState" class="kary-loader" hidden>
                    <div class="spinner-border" role="status" aria-hidden="true"></div>
                    <span class="ms-2">Cargando submódulos…</span>
                </div>
                <div id="errorBox" class="alert alert-danger d-none" role="alert"></div>

                <!-- Acordeón (inyectado por JS) -->
                <div id="submodsList" class="kary-accordion" aria-live="polite"></div>

                <!-- Footer -->
                <div class="action-buttons">
                    <a asp-action="Index" class="btn btn-cancel js-leave">
                        <i class="fa-solid fa-xmark"></i> Cancelar
                    </a>
                    <button type="submit" class="btn btn-save" id="btn-guardar">
                        <i class="fa-solid fa-floppy-disk"></i> Guardar
                    </button>
                </div>
            </form>
        </section>
    </main>
</div>


@section Styles {
    <style>
        /* === Lista de módulos (izquierda) === */
        .modules-list .module-item {
            position: relative; /* permite ubicar la chapa absoluta */
            display: flex;
            align-items: center;
            gap: .75rem;
        }
            /* Píldora "Asignado" alineada a la derecha (sin mover el layout) */
            .modules-list .module-item.assigned::after {
                content: "Asignado";
                position: absolute;
                right: 10px;
                top: 50%;
                transform: translateY(-50%);
                background: #A2D0BC;
                color: #1F2937;
                font-weight: 700;
                font-size: .72rem;
                padding: 2px 8px;
                border-radius: 999px;
            }
            /* Ocultar el chevrón cuando hay chapa (evita que se descuadre) */
            .modules-list .module-item.assigned .bi-chevron-right {
                display: none;
            }
            /* Cuando el módulo está activo (seleccionado) */
            .modules-list .module-item.active {
                background: #376A52;
                color: #fff;
            }

        /* === Submódulos marcados como asignados (acordeón derecha) === */
        .acc-hd.assigned {
            background: #2f5f4f;
            color: #fff;
        }

            .acc-hd.assigned .badge {
                background: #a2d0bc !important;
                color: #1f3a2f !important;
            }
    </style>
}















@section Scripts {
    <script src="~/js/permisos-create.js"></script>
    <script>
        (function () {
          const formSel = '#frmBulk';
          if (window.KarySwal && typeof KarySwal.guardUnsaved === 'function') {
            KarySwal.guardUnsaved(formSel, '.js-leave');
          }
        })();
    </script>

    @* PRG (mensajes tras SaveMultiAssign) *@
    @if (TempData["SavedOk"] as bool? == true)
    {
        var rol = (TempData["SavedRol"] as string) ?? "";
        var count = (TempData["SavedCount"] as int?) ?? 0;
        <script>
            (function () {
              if (window.KarySwal && typeof KarySwal.saveSuccess === 'function') {
                KarySwal.saveSuccess({
                  title: '¡Permisos creados!',
                  text: 'Se asignaron @count permiso(s) para el rol "@rol" en uno o varios módulos.',
                  indexUrl: '@Url.Action("Index", "Permisos", new { rolId = Model.RolId })'
                });
              }
            })();
        </script>
    }
    @if (TempData["SwalWarn"] != null)
    {
        <script>
            (function () {
              if (window.KarySwal?.info) {
                KarySwal.info({
                  title: 'Sin cambios',
                  text: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(TempData["SwalWarn"].ToString())),
                  confirmText: 'Aceptar',
                  redirectUrl: '@Url.Action("Create", "Permisos", new { rolId = Model.RolId })'
                });
              }
            })();
        </script>
    }
    @if (TempData["SwalErr"] != null)
    {
        <script>
            (function () {
              if (window.KarySwal?.error) {
                KarySwal.error({
                  title: 'Error',
                  text: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(TempData["SwalErr"].ToString()))
                });
              }
            })();
        </script>
    }
}
